<!DOCTYPE html>
<html>


<!-- 

     This simple web application takes a list of addresses, plots them
     on a map, uses google maps to calculate turn by turn driving
     directions between the addresses, and plots them on a map,
     including the turn by turn directions highlight along the road
     network, instead of straight, Euclidean lines.

     The google geolocation of users current address, determined by IP
     address geolocation from google maps, only works (so far) if the
     web page is retrieved from a web server and not from the file
     server.

     There is a limit on the number and the size of the turn by turn
     directions requests made to google maps over a period of time for
     a free account. This program tries to gracefully utilize the all
     the capacity allowed and report when it has.

     One objective of this web app is to generate driving time and
     driving distance metrics for a route in order to compare routes
     and route sequences.

-->
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Google Maps JavaScript API v3 Example: Directions Waypoints</title>
    <link href="https://google-developers.appspot.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>

    <script type="text/javascript" src="jquery.js"></script>          

    <script>

// gmaps overlay stuff

// Define the overlay, derived from google.maps.OverlayView
function Label(opt_options) {
    // Initialization
    this.setValues(opt_options);
    
    // Here go the label styles
    var span = this.span_ = document.createElement('span');
    span.style.cssText = 'position: relative; left: -50%; top: -10px; ' +
        'white-space: nowrap;color:#000000;' +
        'padding: 2px;font-family: Arial; font-weight: bold;' +
        'font-size: 30px;';
    
    var div = this.div_ = document.createElement('div');
    div.appendChild(span);
    div.style.cssText = 'position: absolute; display: none';
};

Label.prototype = new google.maps.OverlayView;

Label.prototype.onAdd = function() {
    var pane = this.getPanes().overlayImage;
    pane.appendChild(this.div_);
    
    // Ensures the label is redrawn if the text or position is changed.
    var me = this;
    this.listeners_ = [
        google.maps.event.addListener(this, 'position_changed',
				      function() { me.draw(); }),
        google.maps.event.addListener(this, 'text_changed',
				      function() { me.draw(); }),
        google.maps.event.addListener(this, 'zindex_changed',
				      function() { me.draw(); })
    ];
};

// Implement onRemove
Label.prototype.onRemove = function() {
    this.div_.parentNode.removeChild(this.div_);
    
    // Label is removed from the map, stop updating its position/text.
    for (var i = 0, I = this.listeners_.length; i < I; ++i) {
        google.maps.event.removeListener(this.listeners_[i]);
    }
};

// Implement draw
Label.prototype.draw = function() {
    var projection = this.getProjection();
    var position = projection.fromLatLngToDivPixel(this.get('position'));
    var div = this.div_;
    div.style.left = (position.x + 10) + 'px';
    div.style.top = (position.y + 10) + 'px';
    div.style.display = 'block';
    div.style.zIndex = this.get('zIndex'); //ALLOW LABEL TO OVERLAY MARKER
    this.span_.innerHTML = this.get('text').toString();
};

var geocoder;


var directionDisplay;
var directionsService = new google.maps.DirectionsService();
var map;

var browserSupportFlag =  new Boolean();

function handleNoGeolocation(errorFlag) {
    if (errorFlag == false) {
	alert("Geolocation service succeeded.");
	//     initialLocation = newyork;
    } else {
	alert("Your browser doesn't support geolocation.");
	//      initialLocation = siberia;
    }
    //    map.setCenter(initialLocation);
}

function
noGeolocation()
{
    console.log("noGeolocation(): called");
    handleNoGeolocation(browserSupportFlag);
}

function currentLocationPromise()
{
    var dfd = $.Deferred();

    if (navigator.geolocation) {
        console.log("geolocation:YES");

	navigator.geolocation.getCurrentPosition(
	    function(position) {
		console.log("currentLocationPromise(): got it!");
		initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
		map.setCenter(initialLocation);
	    }, 
	    noGeolocation
	);

    } else{
        console.log("geolocation:NO");
    }

}

function geocodePromise(address){
    console.log("geocodePromise()");

    var dfd = $.Deferred();
    
    geocoder.geocode( { 'address': address}, function(results, status) {

	console.log("before calling resolve");

	
	if (status == google.maps.GeocoderStatus.OK) {

	    theLocation = results[0].geometry.location;


	    console.log("location = " + theLocation);

            var marker = new google.maps.Marker({
		map: map,
		position: results[0].geometry.location

            });

	    var label = new Label({
		map: map
            });
            label.set('zIndex', 1234);
            label.bindTo('position', marker, 'position');
	    label.set('text', "Home");
	    //          label.bindTo('text', marker, 'position');

	    dfd.resolve(theLocation);
	} else {
            alert("Geocode was not successful for the following reason: " + status);
	}
    });

    return dfd.promise();
}

function codeAddress() {

    console.log("codeAddress()");

    var address = "4717 89th Avenue, SE, Mercer Island, WA 98040";

    geocoder.geocode( { 'address': address}, function(results, status) {
	if (status == google.maps.GeocoderStatus.OK) {
            var marker = new google.maps.Marker({
		map: map,
		position: results[0].geometry.location
            });
	} else {
            alert("Geocode was not successful for the following reason: " + status);
	}
    });
}

// XXX Global variables?

var momLocation;
var homeLocation;
var directionsDisplay;

function initialize() {
    directionsDisplay = new google.maps.DirectionsRenderer();

    geocoder = new google.maps.Geocoder();

    var chicago = new google.maps.LatLng(41.850033, -87.6500523);

    var mapOptions = {
        zoom: 11,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: chicago
    }
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
    directionsDisplay.setMap(map);

    if (navigator.geolocation) {
        console.log("geolocation:YES");

	navigator.geolocation.getCurrentPosition(
	    function(position) {
		console.log("got the browser geo code location!");
		initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
		map.setCenter(initialLocation);
	    }, 
	    noGeolocation
	);

    } else{
        console.log("geolocation:NO");
    }

    codeAddress();

    var home = "4717 89th Avenue, SE, Mercer Island, WA 98040";

    var mom = "419 State Street, Johnstown, PA 15905";

    /*
      geocodePromise(mom).done(
      function(x)  {
      console.log('mom is done!');
      console.log('mom is ' + x);
      momLocation = x;
      }
      );

      geocodePromise(home).done(
      function(x)  {
      console.log('home is done!');
      console.log('home is ' + x);
      homeLocation = x;
      }
      );

      $.when(geocodePromise(mom), geocodePromise(home))
      .then(function (result){
      console.log('result = ' + result);
      });
    */

    geocodePromise(mom)
	.then(function (result) { momLocation = result; return geocodePromise(home);})
	.then(function (result) { homeLocation = result; return geocodePromise(mom);})
	.then(function (result) { 
	    console.log("momLocation = " + momLocation);
	    console.log("homeLocation = " + homeLocation);});
}

function 
min (x, y)
{
    if (x < y) return x
    else return y;
}

// for debugging and learning about directions
function
dumpDirectionsResponse(response)
{
    console.log("dumpDirectionsResponse()");
    console.log("my object: %o", response);

    var routes=response.routes.length;
    var legs;
    var steps;
    var paths;
    var path;

    var n=0;
    for (i=0;i<routes;i++){
	legs=response.routes[i].legs.length;
	for (j=0;j<legs;j++){
            steps=response.routes[i].legs[j].steps.length;
            for(k=0;k<steps;k++){
                paths=response.routes[i].legs[j].steps[k].path.length;
		for(m=0;m<paths;m++){
		    path = response.routes[i].legs[j].steps[k].path[m];
		    console.log("path: %o", path);
		    console.log("path as string: %s", path.toString());
		}
	    }
	}
    }
}

function
drawDirectionsPolyline(i, n, result)
{

    var polyline = new google.maps.Polyline({
	path: [],
	strokeColor: '#0000FF',
	strokeWeight: 5
    });

    if (!result) {
	console.log("result is *NULL*");
	return;
    }

    if (result.routes != null) {
    } else {
	console.log("routes is *NULL*");
	return;
    }

    // assumes only one route
    path = result.routes[0].overview_path;
    
    $(path).each(function(index, item) {
	polyline.getPath().push(item);
    });

    polyline.setMap(map);

    // assumes only one leg
    var leg = result.routes[0].legs[0];

    var marker = new google.maps.Marker({
	map: map,
	position: leg.start_location
    });

    var label = new Label({
	map: map
    });
    
    label.bindTo('position', marker, 'position');
    label.set('text', (i+1).toString());

    // decide to draw the destination or not, since we are doing this in a loop

    if (i == (n - 2)) {
	console.log("last one");
	var marker = new google.maps.Marker({
	    map: map,
	    position: leg.end_location
	});

	label.bindTo('position', marker, 'position');
	label.set('text', (i+2).toString());

    }
}

function
newCalcRoutePromise(i, totalLength, start, end)
{
    var dfd = $.Deferred();

    var request = {
        origin: start,
        destination: end,
        travelMode: google.maps.DirectionsTravelMode.DRIVING
    };

    directionsService.route(request, function(response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
	    console.log("status == *OK*");
	    console.log("i == " + i.toString());
	    drawDirectionsPolyline(i, totalLength, response);
	} else {
	    console.log("status == *ERROR*");
	    console.log("status == " + status.toString());
	}
	dfd.resolve();
    });

    return dfd.promise();
}

function 
calcRoute() {

    var summaryPanel = document.getElementById('directions_panel');
    summaryPanel.innerHTML = '... trying to calculate ...';

    var waypts = [];

    var lines = document.listOfLocations.inputList.value;

    //      alert(lines);

    my_lines = lines.split(/\n/); 

    // strip out the empty lines

    old_mylines = my_lines;
    my_lines = [];

    for (var i in old_mylines) {
	var the_line = old_mylines[i];
	console.log("*");
	console.log(the_line)
	if (old_mylines[i].length > 0) {
	    my_lines.push(old_mylines[i]);
	}
	
    }

    var max_gmaps_waypoints = 9;

    n = my_lines.length;

    // alert(n);

    //      alert(my_lines);
    if (n < 2) {
	alert('Need at least two addresses!');
    } else {


        var start = my_lines[0];
        var end = my_lines[n-1];

	// XXX refactoring this function

	if (true) {
	    var totalLength = my_lines.length;

	    for (var i = 0; i < (totalLength - 1); i++) {
		console.log("i == " + i.toString());
		newCalcRoutePromise(i, totalLength, my_lines[i], my_lines[i+1]);		
	    }
	    return;
	}

    
	var last_address_index = min(max_gmaps_waypoints, n - 1);

	for (var i in my_lines) {
	    //      alert(my_lines[i]);
	    if (i > 0 && i < max_gmaps_waypoints) {
		waypts.push({location:my_lines[i], stopover:true});
		console.log(my_lines[i]);

	    }
	}

	if (waypts.length > max_gmaps_waypoints) {
	    summaryPanel.innerHTML = '<b>too many addresses, max is 9!... ' + '</b><br>';
	    summaryPanel.innerHTML += my_lines.length;
	    return;
	}
        var request = {
            origin: start,
            destination: end,
            waypoints: waypts,
            optimizeWaypoints: false,
            travelMode: google.maps.DirectionsTravelMode.DRIVING
        };

        directionsService.route(request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {

		if (false) dumpDirectionsResponse(response);

		if (true) drawDirectionsPolyline(response);

		if (false) directionsDisplay.setDirections(response);

		var route = response.routes[0];
		var summaryPanel = document.getElementById('directions_panel');
		summaryPanel.innerHTML = '';

		var totalMins = 0;
		// For each route, display summary information.
		for (var i = 0; i < route.legs.length; i++) {
		    var routeSegment = i + 1;

		    summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment + '</b><br>';
		    summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
		    summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
		    summaryPanel.innerHTML += route.legs[i].distance.text + '<br>';
		    summaryPanel.innerHTML += route.legs[i].duration.text + '<br>';
		    totalMins += route.legs[i].duration.value;
		}

		summaryPanel.innerHTML += 'Total minutes = ' + totalMins / 60 + '<br>';

	    } else {            

		var summaryPanel = document.getElementById('directions_panel');
		summaryPanel.innerHTML = '... directions failed! ....';
	    }
	}
			       );

    }
}
				
    </script>
  </head>
  <body onload="initialize()">
    <div id="map-canvas" style="float:left;width:70%;height:100%;"></div>
    <div id="control_panel" style="float:right;width:30%;text-align:left;padding-top:20px">
    <div style="margin:20px;border-width:2px;">
    <br>
      <input type="submit" onclick="calcRoute();">
    </div> 

    <form name="listOfLocations">
  <textarea name="inputList" rows="10" cols="70">Bellevue, WA&#013;&#010;Mercer Island, WA&#013;&#010;Seattle, WA</textarea><br>
  </form>
    <div id="directions_panel" style="margin:20px;background-color:#FFEE77;"></div>
    </div>
  </body>
</html>
